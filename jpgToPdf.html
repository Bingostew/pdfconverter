<!DOCTYPE html>
<body>
<span id="test"> testSpan </span>

<div id = "toolBox">
<span class = "ttext">Meta Information</span>
<br>
<input type = "text" id = "name" class="input" value="file name">
<button id = "nameConfirm" class = "button" onclick="saveName();"> Confirm </button>
<br>
<div style="display: flex; flex-direction: row;">
<button id = "canvas" onclick="setMetaSelector('canvas');" class = "checkbox">
<button class = "nullButton">Use On Canvas</button>
</div>
</div>

<span id = "warning"></span>

<br>
<button onclick="addImg();" class = "button" >Add File</button>
<button onclick="removeImg();" class = "button" >Remove File</button>
<button onclick="clearImg();" class = "button" >Clear Files</button>
<button onclick="combine();" class = "button"> Combine To PDF</button>
<br>

<div id = "workContainer" >
<div id = "imc" ></div>
<div id = "preview" style="display: flex; flex-direction: column; width:30%"></div>
<div id = "fileBase" style="display: flex; flex-direction: column; width:30%; float:right;"></div>
</div>

</body>


<style>
    .ttext{
        font-size: large;
        font-weight: bold;
        font-family: Arial;
        margin: 10px;
    }
    .stext{
        font-size: medium;
        font-family: Arial;
        margin: 10px;
    }
    #workContainer{
        display: flex;
    }
    #workContainer > div{
        margin-left: 20px;
    }
    .checkbox{
        height: 20px;
        width: 20px;
        margin: 10px;
        border-color: black;
        border-radius: 5px;
        background-color: white;
    }
    .nullButton{
        background-color: transparent;
        border: none;
        font-size: medium;
        font-family: Arial;
    }
    .input{
        width: fit-content;
        height: 20px;
        font-size: medium;
        font-family: Arial;
        margin:20px;
    }
    #toolBox{
        background-color: blanchedalmond;
        border: 3px solid black;
    }

    #name{
        margin: 10px;
        border: 4px solid rgb(7, 7, 7);
    }
    #warning{
        color: red;
    }
    #imc{
        width: 25%;
    }
    .button{
        background-color: #eeeeee;
        height: 30px;
        border-radius: 10px;
        border-color: black;
        font-family: Arial;
        font-size: small;
        margin: 20px;
    }
    .preview{
        border: 1px solid black;
        height: 300px;
        width: 300px;
    }
    .fileButton{
        border: 1px solid black;
        background-color: #dfdfdf;
        border-radius: 1px;
        font-family: 'Arial';
    }
</style>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
<script>
    var metaInfo = {"canavs":false};

    var imageDiv = document.getElementById("imc");
    var previewDiv = document.getElementById("preview");
    var fileBaseDiv = document.getElementById("fileBase");
    var outputName = document.getElementById("name");
    var warning = document.getElementById("warning");
    var test = document.getElementById("test");
    var inputId = 0;
    var doc = new window.jspdf.jsPDF()

    var unsavedBorder = "4px solid gray";
    var savedBorder = "4px solid green";
    var previewWidth = 300;
    var previewHeight = 300;
    var fileName = "";
    var previewImgSrc = "https://i.ibb.co/6DtpSNY/Screen-Shot-2021-11-19-at-9-30-15-PM.png";


    outputName.onfocus = function(){outputName.style.border = unsavedBorder};
    // Adding a file input, then add a preview image
    function addImg(){

        // Add to preview
        var previewImg = document.createElement("img");
        previewImg.width = previewWidth;
        previewImg.height = previewHeight;
        previewImg.className = "preview";
        previewImg.src = previewImgSrc;
        previewDiv.appendChild(previewImg);

        // Add input file
        var imageInput = document.createElement("input");
        let thisChildIndex = inputId;
        imageInput.type = "file";
        imageInput.id = "im" + inputId;
        imageInput.className = "input";
        imageInput.onchange = function() {updatePreview(thisChildIndex, imageInput);};

        // Animation
        imageInput.style.scale = 0;
        let id = null;
        id = setInterval(moveHandler);
        let t = 0.15;
        function moveHandler(){
            if(parseFloat(imageInput.style.scale) >= 1){
                clearInterval(id);
            }
            else{
                var currentScale = parseFloat(imageInput.style.scale);
                imageInput.style.scale = currentScale + t * t ;
            }
        }
        imageDiv.appendChild(imageInput);
        inputId ++;
    }

    // Remove image from file input list, then remove preview image
    function removeImg(){
        var imageInput = imageDiv.lastElementChild;
        var preview = previewDiv.lastElementChild;

        // Animation
        let id = null;
        id = setInterval(moveHandler);
        let t = 0.15;
        function moveHandler(){
            if(parseFloat(imageInput.style.scale) <= 0){
                clearInterval(id);
                imageDiv.lastElementChild.remove();
                removePreview(parseInt(imageInput.id.charAt(imageDiv.id.length - 1)));
                inputId --;
            }
            else{
                var currentScale = parseFloat(imageInput.style.scale);
                test.innerHTML = currentScale;
                imageInput.style.scale = currentScale - t * t;
                preview.style.scale = currentScale - t * t;
            }
        }
        imageDiv.appendChild(imageInput);
    }

    // Clear file of all inputs 
    function clearImg(){
        for(var i = 0; i < imageDiv.childElementCount; i ++){
            imageDiv.childNodes[i].value = "";
            var preview = previewDiv.childNodes[i];
            preview.src = previewImgSrc;
        }

        // Create a new doc.
        doc = new window.jspdf.jsPDF();
    }

    function setMetaSelector(id){
        test.innerHTML = id;
        var selector = document.getElementById(id);
        metaInfo[id] = !metaInfo[id];
        let selected = metaInfo[id];

        if(selected){
            selector.style.backgroundColor = "green";
        }
        else{
            selector.style.backgroundColor = "white";
        }
    }

    // Use API to combine files into PDF
    function combine(){   
        const fileReader = new FileReader();
        readImage(0);
        let headerImgSrc = ""; // used for filebase

        function readImage(idInt){
            if(idInt >= imageDiv.childElementCount) return;
            var img = new Image();
            var id = "im" + idInt;
            var files = document.getElementById(id).files;
            if(files[0] == null){
                warning.innerHTML = "File not selected!";
                return;
            }
            else if(outputName.style.border == unsavedBorder){
                warning.innerHTML = "File name not confirmed!";
                return;
            }
            else{
                warning.innerHTML = "";
            }
            var file = files[0];
            
            fileReader.onload = function(e){
                img.src = this.result;
                if(idInt != 0){
                    doc.addPage();
                }   
                else{
                    headerImgSrc = this.result;
                }

                if(metaInfo["canvas"]){
                    doc.addImage(img,'JPG',5, 5, 200, 280, null, null, 0);
                }
                else{
                    // Also need to offset image as rotation is not around center
                    // Need to rotate 90 degrees for some reason
                    doc.addImage(img,'JPG', 5 ,-190, 280, 200, null, null, -90);     
                }

                if(idInt == imageDiv.childElementCount - 1){
                    updateFileBase(headerImgSrc);
                }
                readImage(idInt + 1);
            };
            fileReader.readAsDataURL(file);
        }
    }


    // Add downloadable buttons to the filebase column
    function updateFileBase(titleImgSrc){
        var heightOffset = 25;

        var fileButton = document.createElement("img");
        var overlay = document.createElement("div");
        var name = document.createElement("div");

        name.innerHTML = outputName.value + ".pdf";
        name.style.padding = "10px";
        name.style.outline = "1px solid black";
        name.className = "stext";

        overlay.innerHTML = "Download";
        overlay.style.position = "absolute";
        overlay.style.backgroundColor = "#80808090";
        overlay.className = "preview";
        overlay.style.textAlign = "center";
        overlay.style.fontFamily = 'Arial';
        overlay.style.fontSize = "40";

        fileButton.width = previewWidth;
        fileButton.height = previewHeight;
        fileButton.src = titleImgSrc;
        fileButton.className = "fileButton";
        fileButton.onmouseover = function() {
            test.innerHTML = "over";
            overlay.style.display = "block";
            overlay.innerHTML = "Download";
        }
        overlay.onmouseleave = function() {
            test.innerHTML = "out";
            overlay.style.display = "none";
            overlay.innerHTML = "";
        }
        overlay.onclick = function(e) { download(); };

        fileBaseDiv.appendChild(name);
        fileBaseDiv.appendChild(fileButton);
        fileBaseDiv.appendChild(overlay);
    }

    // Handler to update preview images
    function updatePreview(childIndex, element){
        var tgt = element || window.event.srcElement,
        files = element.files;

        if (FileReader && files && files.length) {
            var fr = new FileReader();
            fr.onload = function () {
                var preview = previewDiv.childNodes[childIndex];
                preview.src = fr.result;
                preview.className = "preview";
                test.innerHTML = previewDiv.childElementCount;
            }
            fr.readAsDataURL(files[0]);
        }
    }

    // Handler to delete preview images
    function removePreview(childIndex){
        var preview = previewDiv.childNodes[childIndex];
        preview.remove();
    }

    function saveName(){
        fileName = outputName.value;
        outputName.style.border = savedBorder;
    }

    function download(){
        doc.save(fileName);
    }
</script>